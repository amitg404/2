<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entertainment Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #141414;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        .carousel {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .carousel::-webkit-scrollbar {
            display: none;
        }
        .poster {
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        .poster:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        .video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
        }
        .next-episode-overlay {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 20px;
            border-radius: 8px;
            display: none;
            z-index: 1001;
        }
        .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #3a3a3a 50%, #2a2a2a 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
    </style>
</head>
<body class="text-white">
    <!-- Setup Modal -->
    <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50">
        <div class="bg-gray-900 p-8 rounded-lg max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-6">Welcome to Entertainment Hub</h2>
            <p class="text-gray-400 mb-4">Enter your API credentials to get started:</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Google Drive API Key</label>
                    <input type="text" id="apiKey" class="w-full px-3 py-2 bg-gray-800 rounded border border-gray-700 focus:border-red-600 focus:outline-none" placeholder="AIza...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Google OAuth 2.0 Client ID</label>
                    <input type="text" id="clientId" class="w-full px-3 py-2 bg-gray-800 rounded border border-gray-700 focus:border-red-600 focus:outline-none" placeholder="123456789...">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">TMDb API Key (v3)</label>
                    <input type="text" id="tmdbKey" class="w-full px-3 py-2 bg-gray-800 rounded border border-gray-700 focus:border-red-600 focus:outline-none" placeholder="abc123...">
                </div>
                <div id="setupError" class="text-red-500 text-sm hidden"></div>
                <button id="saveSetup" class="w-full bg-red-600 hover:bg-red-700 py-2 rounded font-semibold transition">Save & Continue</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="fixed top-0 w-full bg-gradient-to-b from-black to-transparent z-40 p-4">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-red-600">ENTERTAINMENT HUB</h1>
                <button id="settingsBtn" class="bg-gray-800 px-4 py-2 rounded hover:bg-gray-700">⚙️ Settings</button>
            </div>
        </header>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-red-600 mx-auto mb-4"></div>
                <p class="text-xl">Loading your library...</p>
            </div>
        </div>

        <!-- Content -->
        <div id="content" class="hidden pt-20 px-4 pb-8">
            <!-- Continue Watching -->
            <div id="continueWatchingSection" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4">Continue Watching</h2>
                <div id="continueWatchingCarousel" class="carousel gap-4"></div>
            </div>

            <!-- Movies -->
            <div id="moviesSection" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4">Movies</h2>
                <div id="moviesCarousel" class="carousel gap-4"></div>
            </div>

            <!-- Film Series -->
            <div id="seriesMoviesSection" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4">Film Series</h2>
                <div id="seriesMoviesCarousel" class="carousel gap-4"></div>
            </div>

            <!-- TV Shows -->
            <div id="tvShowsSection" class="mb-8 hidden">
                <h2 class="text-2xl font-bold mb-4">TV Shows</h2>
                <div id="tvShowsCarousel" class="carousel gap-4"></div>
            </div>
        </div>
    </div>

    <!-- Video Player Overlay -->
    <div id="videoOverlay" class="video-overlay">
        <div class="relative w-full h-full">
            <button id="closePlayer" class="absolute top-4 right-4 bg-black bg-opacity-50 px-4 py-2 rounded-full z-50 hover:bg-opacity-70">✕ Close</button>
            <video id="videoPlayer" class="w-full h-full" controls></video>
            <div id="nextEpisodeOverlay" class="next-episode-overlay">
                <div class="flex items-center gap-4">
                    <img id="nextEpisodePoster" class="w-32 h-20 object-cover rounded" src="" alt="">
                    <div>
                        <p class="text-sm text-gray-400">Next Episode</p>
                        <p id="nextEpisodeTitle" class="font-semibold mb-2"></p>
                        <p class="text-sm">Starting in <span id="countdown">5</span> seconds...</p>
                    </div>
                    <button id="cancelNext" class="bg-gray-700 px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let apiKey, clientId, tmdbKey, accessToken;
        let library = { movies: [], filmSeries: [], tvShows: [] };
        let continueWatching = [];
        let currentPlayingItem = null;
        let nextEpisodeTimer = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            loadCredentials();
            if (apiKey && clientId && tmdbKey) {
                document.getElementById('setupModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                authenticate();
            }
        }

        function loadCredentials() {
            apiKey = localStorage.getItem('gdrive_api_key');
            clientId = localStorage.getItem('gdrive_client_id');
            tmdbKey = localStorage.getItem('tmdb_api_key');
            continueWatching = JSON.parse(localStorage.getItem('continue_watching') || '[]');
        }

        document.getElementById('saveSetup').addEventListener('click', () => {
            const key = document.getElementById('apiKey').value.trim();
            const client = document.getElementById('clientId').value.trim();
            const tmdb = document.getElementById('tmdbKey').value.trim();

            if (!key || !client || !tmdb) {
                document.getElementById('setupError').textContent = 'All fields are required';
                document.getElementById('setupError').classList.remove('hidden');
                return;
            }

            localStorage.setItem('gdrive_api_key', key);
            localStorage.setItem('gdrive_client_id', client);
            localStorage.setItem('tmdb_api_key', tmdb);

            apiKey = key;
            clientId = client;
            tmdbKey = tmdb;

            document.getElementById('setupModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            authenticate();
        });

        document.getElementById('settingsBtn').addEventListener('click', () => {
            if (confirm('Reset all settings and credentials?')) {
                localStorage.clear();
                location.reload();
            }
        });

        function authenticate() {
            // Wait for gapi to be available
            const checkGapi = setInterval(() => {
                if (typeof gapi !== 'undefined') {
                    clearInterval(checkGapi);
                    initGapi();
                }
            }, 100);
        }

        function initGapi() {
            gapi.load('client:auth2', async () => {
                try {
                    await gapi.client.init({
                        apiKey: apiKey,
                        clientId: clientId,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                        scope: 'https://www.googleapis.com/auth/drive.readonly'
                    });

                    const authInstance = gapi.auth2.getAuthInstance();
                    if (!authInstance.isSignedIn.get()) {
                        await authInstance.signIn();
                    }

                    accessToken = gapi.auth.getToken().access_token;
                    await loadLibrary();
                } catch (error) {
                    console.error('Authentication error details:', error);
                    alert('Authentication failed. Please check:\n1. Your Client ID is correct\n2. You have enabled Google Drive API\n3. You have configured OAuth consent screen\n\nError: ' + (error.message || error.error || 'Unknown error'));
                    document.getElementById('loadingScreen').classList.add('hidden');
                }
            });
        }

        async function loadLibrary() {
            try {
                // Find Entertainment folder
                const entertainmentFolder = await findFolder('Entertainment', 'root');
                if (!entertainmentFolder) {
                    alert('Entertainment folder not found in your Google Drive');
                    return;
                }

                // Load Movies
                const moviesFolder = await findFolder('Movies', entertainmentFolder.id);
                if (moviesFolder) {
                    library.movies = await parseMovies(moviesFolder.id);
                }

                // Load Film Series
                const filmSeriesFolder = await findFolder('Film Series', entertainmentFolder.id);
                if (filmSeriesFolder) {
                    library.filmSeries = await parseFilmSeries(filmSeriesFolder.id);
                }

                // Load TV Shows
                const seriesFolder = await findFolder('Series', entertainmentFolder.id);
                if (seriesFolder) {
                    library.tvShows = await parseTVShows(seriesFolder.id);
                }

                renderLibrary();
            } catch (error) {
                console.error('Error loading library:', error);
                alert('Error loading library: ' + error.message);
            }
        }

        async function findFolder(name, parentId) {
            const response = await gapi.client.drive.files.list({
                q: `name='${name}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id, name)',
                pageSize: 1
            });
            return response.result.files[0];
        }

        async function listFolders(parentId) {
            const response = await gapi.client.drive.files.list({
                q: `'${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
                fields: 'files(id, name)',
                pageSize: 1000
            });
            return response.result.files;
        }

        async function listVideoFiles(folderId) {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and (mimeType contains 'video/' or name contains '.mp4' or name contains '.mkv' or name contains '.avi') and trashed=false`,
                fields: 'files(id, name, mimeType)',
                pageSize: 1000
            });
            return response.result.files;
        }

        async function parseMovies(moviesFolderId) {
            const movies = [];
            const movieFolders = await listFolders(moviesFolderId);

            for (const folder of movieFolders) {
                const videoFiles = await listVideoFiles(folder.id);
                if (videoFiles.length > 0) {
                    const metadata = await getTMDbMovieData(folder.name);
                    movies.push({
                        type: 'movie',
                        title: folder.name,
                        fileId: videoFiles[0].id,
                        fileName: videoFiles[0].name,
                        ...metadata
                    });
                }
            }
            return movies;
        }

        async function parseFilmSeries(filmSeriesFolderId) {
            const allMovies = [];
            const seriesFolders = await listFolders(filmSeriesFolderId);

            for (const seriesFolder of seriesFolders) {
                const movieFolders = await listFolders(seriesFolder.id);
                for (const movieFolder of movieFolders) {
                    const videoFiles = await listVideoFiles(movieFolder.id);
                    if (videoFiles.length > 0) {
                        const metadata = await getTMDbMovieData(movieFolder.name);
                        allMovies.push({
                            type: 'series-movie',
                            series: seriesFolder.name,
                            title: movieFolder.name,
                            fileId: videoFiles[0].id,
                            fileName: videoFiles[0].name,
                            ...metadata
                        });
                    }
                }
            }
            return allMovies;
        }

        async function parseTVShows(seriesFolderId) {
            const shows = [];
            const showFolders = await listFolders(seriesFolderId);

            for (const showFolder of showFolders) {
                const showMetadata = await getTMDbTVData(showFolder.name);
                const seasonFolders = await listFolders(showFolder.id);
                const seasons = [];

                for (const seasonFolder of seasonFolders) {
                    const seasonMatch = seasonFolder.name.match(/Season\s*(\d+)/i);
                    const seasonNumber = seasonMatch ? parseInt(seasonMatch[1]) : 1;
                    const videoFiles = await listVideoFiles(seasonFolder.id);

                    const episodes = videoFiles.map((file, idx) => ({
                        fileId: file.id,
                        fileName: file.name,
                        episodeNumber: idx + 1,
                        seasonNumber: seasonNumber
                    }));

                    seasons.push({
                        seasonNumber: seasonNumber,
                        episodes: episodes
                    });
                }

                shows.push({
                    type: 'tv-show',
                    title: showFolder.name,
                    seasons: seasons,
                    ...showMetadata
                });
            }
            return shows;
        }

        async function getTMDbMovieData(title) {
            try {
                const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${tmdbKey}&query=${encodeURIComponent(title)}`;
                const searchRes = await fetch(searchUrl);
                const searchData = await searchRes.json();

                if (searchData.results && searchData.results.length > 0) {
                    const movie = searchData.results[0];
                    return {
                        poster: movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : null,
                        backdrop: movie.backdrop_path ? `https://image.tmdb.org/t/p/original${movie.backdrop_path}` : null,
                        overview: movie.overview,
                        releaseDate: movie.release_date,
                        rating: movie.vote_average
                    };
                }
            } catch (error) {
                console.error('TMDb error:', error);
            }
            return {};
        }

        async function getTMDbTVData(title) {
            try {
                const searchUrl = `https://api.themoviedb.org/3/search/tv?api_key=${tmdbKey}&query=${encodeURIComponent(title)}`;
                const searchRes = await fetch(searchUrl);
                const searchData = await searchRes.json();

                if (searchData.results && searchData.results.length > 0) {
                    const show = searchData.results[0];
                    return {
                        poster: show.poster_path ? `https://image.tmdb.org/t/p/w500${show.poster_path}` : null,
                        backdrop: show.backdrop_path ? `https://image.tmdb.org/t/p/original${show.backdrop_path}` : null,
                        overview: show.overview,
                        firstAirDate: show.first_air_date,
                        rating: show.vote_average
                    };
                }
            } catch (error) {
                console.error('TMDb error:', error);
            }
            return {};
        }

        function renderLibrary() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            // Continue Watching
            if (continueWatching.length > 0) {
                renderContinueWatching();
            }

            // Movies
            if (library.movies.length > 0) {
                document.getElementById('moviesSection').classList.remove('hidden');
                renderCarousel('moviesCarousel', library.movies);
            }

            // Film Series
            if (library.filmSeries.length > 0) {
                document.getElementById('seriesMoviesSection').classList.remove('hidden');
                renderCarousel('seriesMoviesCarousel', library.filmSeries);
            }

            // TV Shows
            if (library.tvShows.length > 0) {
                document.getElementById('tvShowsSection').classList.remove('hidden');
                renderTVShows();
            }
        }

        function renderContinueWatching() {
            document.getElementById('continueWatchingSection').classList.remove('hidden');
            const carousel = document.getElementById('continueWatchingCarousel');
            carousel.innerHTML = '';

            continueWatching.forEach(item => {
                const card = createPosterCard(item);
                carousel.appendChild(card);
            });
        }

        function renderCarousel(carouselId, items) {
            const carousel = document.getElementById(carouselId);
            carousel.innerHTML = '';

            items.forEach(item => {
                const card = createPosterCard(item);
                carousel.appendChild(card);
            });
        }

        function renderTVShows() {
            const carousel = document.getElementById('tvShowsCarousel');
            carousel.innerHTML = '';

            library.tvShows.forEach(show => {
                const card = createTVShowCard(show);
                carousel.appendChild(card);
            });
        }

        function createPosterCard(item) {
            const div = document.createElement('div');
            div.className = 'poster flex-shrink-0';
            div.innerHTML = `
                <img src="${item.poster || 'https://via.placeholder.com/300x450?text=No+Poster'}" 
                     alt="${item.title}" 
                     class="w-48 h-72 object-cover rounded-lg shadow-lg">
                <p class="text-sm mt-2 text-center truncate w-48">${item.title}</p>
            `;
            div.addEventListener('click', () => playItem(item));
            return div;
        }

        function createTVShowCard(show) {
            const div = document.createElement('div');
            div.className = 'poster flex-shrink-0';
            div.innerHTML = `
                <img src="${show.poster || 'https://via.placeholder.com/300x450?text=No+Poster'}" 
                     alt="${show.title}" 
                     class="w-48 h-72 object-cover rounded-lg shadow-lg">
                <p class="text-sm mt-2 text-center truncate w-48">${show.title}</p>
            `;
            div.addEventListener('click', () => showEpisodeSelector(show));
            return div;
        }

        function showEpisodeSelector(show) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black bg-opacity-95 z-50 overflow-y-auto p-4';
            
            let html = `
                <div class="max-w-6xl mx-auto">
                    <button class="float-right text-3xl">&times;</button>
                    <div class="mb-8">
                        <h2 class="text-4xl font-bold mb-4">${show.title}</h2>
                        <p class="text-gray-400 max-w-3xl">${show.overview || ''}</p>
                    </div>
            `;

            show.seasons.forEach(season => {
                html += `
                    <div class="mb-6">
                        <h3 class="text-2xl font-semibold mb-4">Season ${season.seasonNumber}</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                `;
                season.episodes.forEach(episode => {
                    html += `
                        <div class="bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700" 
                             data-file-id="${episode.fileId}" 
                             data-episode="${episode.episodeNumber}"
                             data-season="${episode.seasonNumber}">
                            <p class="font-semibold">Episode ${episode.episodeNumber}</p>
                            <p class="text-sm text-gray-400 truncate">${episode.fileName}</p>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });

            html += `</div>`;
            overlay.innerHTML = html;

            overlay.querySelector('button').addEventListener('click', () => overlay.remove());
            overlay.querySelectorAll('[data-file-id]').forEach(el => {
                el.addEventListener('click', () => {
                    const episodeData = {
                        type: 'tv-episode',
                        showTitle: show.title,
                        fileId: el.dataset.fileId,
                        seasonNumber: parseInt(el.dataset.season),
                        episodeNumber: parseInt(el.dataset.episode),
                        poster: show.poster,
                        show: show
                    };
                    playItem(episodeData);
                    overlay.remove();
                });
            });

            document.body.appendChild(overlay);
        }

        async function playItem(item) {
            currentPlayingItem = item;
            const videoUrl = `https://www.googleapis.com/drive/v3/files/${item.fileId}?alt=media&key=${apiKey}`;
            
            const videoPlayer = document.getElementById('videoPlayer');
            const videoOverlay = document.getElementById('videoOverlay');
            
            videoPlayer.src = videoUrl;
            videoOverlay.style.display = 'block';
            videoPlayer.play();

            // Add to continue watching
            addToContinueWatching(item);

            // Setup next episode for TV shows
            if (item.type === 'tv-episode') {
                setupNextEpisode(item);
            }

            // Track progress
            videoPlayer.addEventListener('timeupdate', () => {
                if (item.type === 'tv-episode' && videoPlayer.duration - videoPlayer.currentTime <= 20) {
                    showNextEpisodeOverlay();
                }
            });
        }

        function setupNextEpisode(currentEpisode) {
            const show = currentEpisode.show;
            const currentSeason = show.seasons.find(s => s.seasonNumber === currentEpisode.seasonNumber);
            
            if (currentSeason) {
                const nextEpisode = currentSeason.episodes.find(e => e.episodeNumber === currentEpisode.episodeNumber + 1);
                
                if (nextEpisode) {
                    currentPlayingItem.nextEpisode = {
                        ...nextEpisode,
                        type: 'tv-episode',
                        showTitle: show.title,
                        poster: show.poster,
                        show: show
                    };
                }
            }
        }

        function showNextEpisodeOverlay() {
            if (!currentPlayingItem.nextEpisode) return;

            const overlay = document.getElementById('nextEpisodeOverlay');
            const countdownEl = document.getElementById('countdown');
            const titleEl = document.getElementById('nextEpisodeTitle');
            const posterEl = document.getElementById('nextEpisodePoster');

            const nextEp = currentPlayingItem.nextEpisode;
            titleEl.textContent = `S${nextEp.seasonNumber}E${nextEp.episodeNumber}`;
            posterEl.src = nextEp.poster || 'https://via.placeholder.com/128x80';

            overlay.style.display = 'block';

            let countdown = 5;
            countdownEl.textContent = countdown;

            nextEpisodeTimer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;

                if (countdown <= 0) {
                    clearInterval(nextEpisodeTimer);
                    overlay.style.display = 'none';
                    playItem(nextEp);
                }
            }, 1000);
        }

        document.getElementById('cancelNext').addEventListener('click', () => {
            clearInterval(nextEpisodeTimer);
            document.getElementById('nextEpisodeOverlay').style.display = 'none';
        });

        document.getElementById('closePlayer').addEventListener('click', () => {
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.pause();
            videoPlayer.src = '';
            document.getElementById('videoOverlay').style.display = 'none';
            clearInterval(nextEpisodeTimer);
            document.getElementById('nextEpisodeOverlay').style.display = 'none';
        });

        function addToContinueWatching(item) {
            // Remove if already exists
            continueWatching = continueWatching.filter(i => i.fileId !== item.fileId);
            
            // Add to beginning
            continueWatching.unshift(item);
            
            // Keep only last 10
            if (continueWatching.length > 10) {
                continueWatching = continueWatching.slice(0, 10);
            }
            
            localStorage.setItem('continue_watching', JSON.stringify(continueWatching));
            renderContinueWatching();
        }
    </script>
    <script src="https://apis.google.com/js/api.js"></script>
</body>
</html>
