<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Super Drive Hub v4.5</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
    .poster-card { transition: transform 0.25s ease-in-out; }
    .poster-card:hover { transform: scale(1.06); }
    .carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 20px; }
    .carousel > div { scroll-snap-align: start; flex-shrink: 0; }
    #videoPlayer iframe { width: 100%; height: 100%; }
    .modal-bg { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>
</head>

<body class="bg-gray-900 text-white antialiased">
  <div id="app">
    <!-- LOADING / CREDENTIALS -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center p-4">
      <div id="credentialsBox" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8 hidden">
        <h1 class="text-3xl font-bold text-center mb-2 text-red-500">Super Drive Hub</h1>
        <p class="text-center text-gray-400 mb-8">Enter your API credentials to begin.</p>

        <div class="space-y-4">
          <div>
            <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">Google API Key</label>
            <input type="password" id="apiKey"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none" />
          </div>
          <div>
            <label for="clientId" class="block text-sm font-medium text-gray-300 mb-1">Google Client ID</label>
            <input type="password" id="clientId"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none" />
          </div>
          <div>
            <label for="tmdbApiKey" class="block text-sm font-medium text-gray-300 mb-1">TMDb API Key</label>
            <input type="password" id="tmdbApiKey"
              class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none" />
          </div>
        </div>

        <button id="authButton"
          class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-8 transition-colors duration-200">
          Connect to Google Drive
        </button>
      </div>

      <div id="loadingIndicator" class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto"></div>
        <p id="loadingStatus" class="mt-4 text-lg">Initializing...</p>
      </div>
    </div>

    <!-- MAIN HUB -->
    <div id="mainHub" class="hidden p-4 sm:p-6 md:p-8">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-red-500">Browse</h1>
        <button id="logoutButton" class="text-gray-400 hover:text-white transition-colors duration-200">Logout</button>
      </div>
      <div id="hubContent"></div>

      <div id="scanButtonContainer" class="text-center my-8 hidden">
        <button id="scanButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
          Scan Google Drive for Media
        </button>
        <p class="text-sm text-gray-400 mt-2">Required for first-time setup or to find new content.</p>
      </div>
    </div>

    <!-- DETAILS MODAL -->
    <div id="detailsModal" class="hidden fixed inset-0 z-40 overflow-y-auto">
      <div class="fixed inset-0 bg-black bg-opacity-75 modal-bg"></div>
      <div id="detailsContent" class="relative min-h-screen"></div>
    </div>

    <!-- VIDEO PLAYER -->
    <div id="videoPlayer" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center">
      <button id="closePlayer" class="absolute top-4 right-4 text-white text-4xl font-bold z-50">&times;</button>
      <div class="w-full h-full flex items-center justify-center p-4">
        <div id="playerContainer"
          class="relative w-full max-w-6xl aspect-video bg-black rounded-lg overflow-hidden shadow-2xl text-center flex items-center justify-center"></div>
      </div>
      <div id="playerControls" class="absolute bottom-5 right-5 z-50">
        <button id="nextEpisodeBtn"
          class="hidden bg-gray-800/80 hover:bg-gray-700/90 py-2 px-4 rounded-lg">Next Episode &gt;</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------------------------------
    // CORE CONFIGURATION
    // ----------------------------------------------------
    const config = {
      DRIVE_API_KEY_STORAGE: 'superdrivehub_v4_google_api_key',
      DRIVE_CLIENT_ID_STORAGE: 'superdrivehub_v4_google_client_id',
      TMDB_API_KEY_STORAGE: 'superdrivehub_v4_tmdb_api_key',
      LIBRARY_STORAGE: 'superdrivehub_v4_library_cache',
      CONTINUE_WATCHING_STORAGE: 'superdrivehub_v4_continue_watching',
      TMDB_BASE_URL: 'https://api.themoviedb.org/3',
      TMDB_IMG_URL: 'https://image.tmdb.org/t/p/w500',
      MAIN_FOLDER_NAME: 'Entertainment'
    };

    const state = {
      gapiInited: false,
      gsiInited: false,
      tokenClient: null,
      library: { movies: [], filmSeries: [], tvSeries: [] },
      continueWatching: [],
      currentPlaying: null,
      activeDetailItem: null
    };

    // ----------------------------------------------------
    // ELEMENT REFERENCES
    // ----------------------------------------------------
    const elements = {
      loadingScreen: document.getElementById('loadingScreen'),
      credentialsBox: document.getElementById('credentialsBox'),
      loadingIndicator: document.getElementById('loadingIndicator'),
      loadingStatus: document.getElementById('loadingStatus'),
      mainHub: document.getElementById('mainHub'),
      hubContent: document.getElementById('hubContent'),
      scanButtonContainer: document.getElementById('scanButtonContainer'),
      detailsModal: document.getElementById('detailsModal'),
      detailsContent: document.getElementById('detailsContent'),
      videoPlayer: document.getElementById('videoPlayer'),
      playerContainer: document.getElementById('playerContainer'),
      nextEpisodeBtn: document.getElementById('nextEpisodeBtn'),
      closePlayer: document.getElementById('closePlayer'),
      authButton: document.getElementById('authButton'),
      logoutButton: document.getElementById('logoutButton'),
      scanButton: document.getElementById('scanButton'),
      apiKey: document.getElementById('apiKey'),
      clientId: document.getElementById('clientId'),
      tmdbApiKey: document.getElementById('tmdbApiKey')
    };

    // ----------------------------------------------------
    // INITIALIZATION
    // ----------------------------------------------------
    window.onload = () => {
      loadSavedCredentials();
      loadCachedData();

      if (elements.apiKey.value && elements.clientId.value) {
        updateStatus("Loading Google Libraries...");
        gapiLoaded();
        gisLoaded();
      } else {
        showCredentialsScreen();
      }
    };

    const loadSavedCredentials = () => {
      elements.apiKey.value = localStorage.getItem(config.DRIVE_API_KEY_STORAGE) || '';
      elements.clientId.value = localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE) || '';
      elements.tmdbApiKey.value = localStorage.getItem(config.TMDB_API_KEY_STORAGE) || '';
    };

    const loadCachedData = () => {
      const cachedLibrary = localStorage.getItem(config.LIBRARY_STORAGE);
      if (cachedLibrary) state.library = JSON.parse(cachedLibrary);
      const continueWatchingData = localStorage.getItem(config.CONTINUE_WATCHING_STORAGE);
      if (continueWatchingData) state.continueWatching = JSON.parse(continueWatchingData);
    };

    const showCredentialsScreen = () => {
      elements.loadingIndicator.style.display = 'none';
      elements.credentialsBox.style.display = 'block';
    };

    // ----------------------------------------------------
    // AUTH HANDLERS
    // ----------------------------------------------------
    elements.authButton.addEventListener('click', () => {
      const apiKey = elements.apiKey.value.trim();
      const clientId = elements.clientId.value.trim();
      const tmdbApiKey = elements.tmdbApiKey.value.trim();

      if (apiKey && clientId && tmdbApiKey) {
        localStorage.setItem(config.DRIVE_API_KEY_STORAGE, apiKey);
        localStorage.setItem(config.DRIVE_CLIENT_ID_STORAGE, clientId);
        localStorage.setItem(config.TMDB_API_KEY_STORAGE, tmdbApiKey);

        if (!state.gapiInited || !state.gsiInited) {
          window.location.reload();
        } else {
          handleManualAuthClick();
        }
      } else {
        alert('Please enter all three API keys.');
      }
    });

    elements.logoutButton.addEventListener('click', () => {
      Object.values(config).forEach(key => localStorage.removeItem(key));
      window.location.reload();
    });

    // ----------------------------------------------------
    // GOOGLE API INIT
    // ----------------------------------------------------
    function gapiLoaded() { gapi.load('client', initializeGapiClient); }

    async function initializeGapiClient() {
      try {
        updateStatus("Initializing Drive API...");
        await gapi.client.init({
          apiKey: localStorage.getItem(config.DRIVE_API_KEY_STORAGE),
          discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
        });
        state.gapiInited = true;
        attemptSilentLogin();
      } catch (error) {
        console.error("GAPI client initialization error:", error);
        handleInitializationError("Failed to initialize Google Drive API. Check your API Key and Drive API access.");
      }
    }

    function gisLoaded() {
      try {
        updateStatus("Initializing Authentication...");
        state.tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE),
          scope: 'https://www.googleapis.com/auth/drive.readonly',
          callback: (tokenResponse) => {
            if (tokenResponse?.access_token) switchToMainHub();
            else showCredentialsScreen();
          }
        });
        state.gsiInited = true;
        attemptSilentLogin();
      } catch (error) {
        console.error("GSI client initialization error:", error);
        handleInitializationError("Failed to initialize Google Authentication. Verify Client ID configuration.");
      }
    }

    function handleInitializationError(message) {
      updateStatus(message);
      setTimeout(showCredentialsScreen, 3000);
    }

    function attemptSilentLogin() {
      if (state.gapiInited && state.gsiInited) {
        updateStatus("Connecting to Google...");
        state.tokenClient.requestAccessToken({ prompt: 'none' });
      }
    }

    const handleManualAuthClick = () => {
      if (state.tokenClient) state.tokenClient.requestAccessToken({ prompt: 'consent' });
      else alert("Authentication client not ready. Please wait or refresh.");
    };

    // ----------------------------------------------------
    // SWITCH TO MAIN HUB
    // ----------------------------------------------------
    function switchToMainHub() {
      elements.loadingScreen.style.display = 'none';
      elements.mainHub.style.display = 'block';
      if (Object.values(state.library).every(arr => arr.length === 0)) {
        elements.scanButtonContainer.style.display = 'block';
      } else {
        elements.scanButtonContainer.style.display = 'none';
        renderMainHub();
      }
    }

    // ----------------------------------------------------
    // UI UTILITIES
    // ----------------------------------------------------
    const updateStatus = msg => elements.loadingStatus.innerText = msg;

    const showMessage = msg => {
      updateStatus(msg);
      console.log(msg);
    };

    // ----------------------------------------------------
    // LIBRARY SCAN
    // ----------------------------------------------------
    elements.scanButton.addEventListener('click', startLibraryScan);

    async function startLibraryScan() {
      elements.scanButtonContainer.style.display = 'none';
      elements.loadingScreen.style.display = 'flex';
      elements.loadingIndicator.style.display = 'block';

      try {
        updateStatus(`Finding '${config.MAIN_FOLDER_NAME}' folder...`);
        const mainFolderId = await findFolderId(config.MAIN_FOLDER_NAME);
        if (!mainFolderId) throw new Error(`Main folder '${config.MAIN_FOLDER_NAME}' not found.`);

        updateStatus("Scanning library structure...");
        const folders = await listItemsInFolder(mainFolderId, "mimeType='application/vnd.google-apps.folder'");
        const tempLibrary = { movies: [], filmSeries: [], tvSeries: [] };

        for (const folder of folders) {
          const name = folder.name.toLowerCase();
          if (name === 'movies') tempLibrary.movies = await processMovieFolder(folder.id);
          else if (name === 'film series') tempLibrary.filmSeries = await processSeriesFolder(folder.id, 'filmSeries');
          else if (name === 'series') tempLibrary.tvSeries = await processSeriesFolder(folder.id, 'tvSeries');
        }

        state.library = tempLibrary;
        localStorage.setItem(config.LIBRARY_STORAGE, JSON.stringify(tempLibrary));
        switchToMainHub();
      } catch (error) {
        console.error("Library Scan Failed:", error);
        updateStatus("Scan failed. Check console for details.");
        setTimeout(switchToMainHub, 3000);
      }
    }

    // (All remaining functions: findFolderId, listItemsInFolder, processMovieFolder, processSeriesFolder,
    // getTMDbData, renderMainHub, createCarousel, showDetails, closeDetails, openPlayer,
    // hasNextEpisode, playNextEpisode, handleMetadataCorrection, findLibraryItem, updateContinueWatching)
    // REMAIN UNCHANGED — they retain identical logic and behavior as your provided version.
  </script>
</body>
</html>
